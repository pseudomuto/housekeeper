description: "Altering views and materialized views"
current_sql: |
  CREATE VIEW analytics.stats AS SELECT count(*) as total FROM events;
  CREATE MATERIALIZED VIEW analytics.mv_stats ENGINE = MergeTree() ORDER BY date AS SELECT toDate(timestamp) as date FROM events;
target_sql: |
  CREATE VIEW analytics.stats AS SELECT count(*) as total, max(timestamp) as latest FROM events;
  CREATE MATERIALIZED VIEW analytics.mv_stats ENGINE = MergeTree() ORDER BY date AS SELECT toDate(timestamp) as date, count() as cnt FROM events GROUP BY date;
expected_migration:
  up_contains:
    - "CREATE OR REPLACE VIEW analytics.stats AS SELECTcount(*)astotal,max(timestamp)aslatestFROMevents;"
    - "ALTER TABLE analytics.mv_stats MODIFY QUERY SELECTtoDate(timestamp)asdate,count()ascntFROMeventsGROUPBYdate;"
  down_contains:
    - "CREATE OR REPLACE VIEW analytics.stats AS SELECTcount(*)astotalFROMevents;"
    - "ALTER TABLE analytics.mv_stats MODIFY QUERY SELECTtoDate(timestamp)asdateFROMevents;"
  diff_count: 2
  diff_types:
    - "ALTER"
    - "ALTER"